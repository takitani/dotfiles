#!/bin/bash
# Script para restaurar conexÃµes Remmina do 1Password

set -e

echo "ðŸ“¦ Configurando conexÃµes Remmina do 1Password..."

# Verificar se o 1Password CLI estÃ¡ instalado
if ! command -v op &> /dev/null; then
    echo "âš ï¸  1Password CLI nÃ£o estÃ¡ instalado. Execute o script setup-pgpass primeiro."
    exit 1
fi

# Verificar se o Remmina estÃ¡ instalado
if ! command -v remmina &> /dev/null; then
    echo "ðŸ“¦ Instalando Remmina..."
    if [ -f /etc/arch-release ]; then
        sudo pacman -S --noconfirm remmina freerdp
    else
        sudo apt-get install -y remmina remmina-plugin-rdp
    fi
fi

# Criar diretÃ³rio do Remmina se nÃ£o existir
mkdir -p ~/.local/share/remmina

# FunÃ§Ã£o para fazer login no 1Password (reutiliza sessÃ£o se existir)
op_signin() {
    if ! op account list &>/dev/null; then
        echo "ðŸ” Fazendo login no 1Password..."
        eval $(op signin)
    fi
}

op_signin

# Buscar todos os items RDP/VMs
echo "ðŸ” Buscando conexÃµes RDP/VM no 1Password..."

# Listar items que parecem ser conexÃµes RDP (ajuste conforme necessÃ¡rio)
ITEMS=$(op item list --categories "Server" --format json 2>/dev/null || \
        op item list --tags "rdp,vm,remote" --format json 2>/dev/null || \
        op item list --format json | jq '.[] | select(.title | ascii_downcase | contains("rdp") or contains("vm") or contains("remote"))')

if [ -z "$ITEMS" ]; then
    echo "âš ï¸  Nenhuma conexÃ£o RDP/VM encontrada no 1Password"
    echo "   Certifique-se de que seus items estÃ£o categorizados como 'Server'"
    echo "   ou possuem tags como 'rdp', 'vm' ou 'remote'"
    
    echo ""
    echo "Deseja configurar manualmente? (s/n)"
    read -r MANUAL
    
    if [ "$MANUAL" != "s" ]; then
        exit 0
    fi
    
    echo "Digite o nome do item no 1Password:"
    read -r ITEM_NAME
    ITEMS=$(op item get "$ITEM_NAME" --format json)
fi

# Processar cada item encontrado
echo "$ITEMS" | jq -c '.' | while IFS= read -r item; do
    TITLE=$(echo "$item" | jq -r '.title')
    ITEM_ID=$(echo "$item" | jq -r '.id')
    
    echo "ðŸ“Œ Processando: $TITLE"
    
    # Obter detalhes completos do item
    FULL_ITEM=$(op item get "$ITEM_ID" --format json)
    
    # Extrair campos RDP
    SERVER=$(echo "$FULL_ITEM" | jq -r '.fields[] | select(.label=="server" or .label=="Server" or .label=="host" or .label=="Host" or .label=="address" or .label=="Address") | .value' | head -n1)
    USERNAME=$(echo "$FULL_ITEM" | jq -r '.fields[] | select(.label=="username" or .label=="Username" or .purpose=="USERNAME") | .value' | head -n1)
    PASSWORD=$(echo "$FULL_ITEM" | jq -r '.fields[] | select(.label=="password" or .label=="Password" or .purpose=="PASSWORD") | .value' | head -n1)
    DOMAIN=$(echo "$FULL_ITEM" | jq -r '.fields[] | select(.label=="domain" or .label=="Domain") | .value' | head -n1)
    PORT=$(echo "$FULL_ITEM" | jq -r '.fields[] | select(.label=="port" or .label=="Port") | .value' | head -n1)
    
    # Valores padrÃ£o
    PORT=${PORT:-3389}
    
    if [ -n "$SERVER" ] && [ -n "$USERNAME" ]; then
        # Criar nome de arquivo seguro
        FILENAME=$(echo "$TITLE" | tr ' /' '_' | tr -cd '[:alnum:]_-')
        FILEPATH="$HOME/.local/share/remmina/${FILENAME}.remmina"
        
        echo "   Criando: $FILEPATH"
        
        # Criar arquivo de conexÃ£o Remmina
        cat > "$FILEPATH" << EOF
[remmina]
group=
protocol=RDP
server=$SERVER
username=$USERNAME
password=$PASSWORD
domain=$DOMAIN
resolution_mode=2
color_depth=32
glyph_cache=1
precommand=
postcommand=
name=$TITLE
shareprinter=0
sharesmartcard=0
resolution_width=1920
resolution_height=1080
EOF
        
        # Definir permissÃµes
        chmod 600 "$FILEPATH"
        
        echo "   âœ… ConexÃ£o criada"
    else
        echo "   âš ï¸  Campos obrigatÃ³rios faltando (server/username)"
    fi
done

echo ""
echo "âœ… ConfiguraÃ§Ã£o do Remmina concluÃ­da!"
echo "   ConexÃµes salvas em: ~/.local/share/remmina/"

# Limpar variÃ¡veis sensÃ­veis
unset PASSWORD USERNAME DOMAIN SERVER PORT